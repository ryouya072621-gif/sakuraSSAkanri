{% extends "base.html" %}

{% block title %}スタッフ別比較 - 個人業務分析レポート{% endblock %}

{% block extra_css %}
<style>
.star-rating {
    color: #fbbf24;
}
.progress-thin {
    height: 8px;
}
.staff-card {
    transition: transform 0.2s;
}
.staff-card:hover {
    transform: translateY(-2px);
}
@media print {
    .sidebar { display: none !important; }
    .main-content { margin-left: 0 !important; }
    .no-print { display: none !important; }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex">
    <!-- サイドバー -->
    <div class="sidebar bg-white border-end p-3 no-print" style="width: 280px; min-height: 100vh;">
        <div class="d-flex align-items-center mb-4">
            <div class="rounded-circle bg-info d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                <i class="bi bi-people text-white"></i>
            </div>
            <div>
                <h5 class="mb-0">スタッフ別比較</h5>
                <small class="text-muted">業務時間・効率性の比較分析</small>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">分析条件設定</label>
        </div>

        <div class="mb-3">
            <label class="form-label">大分類（部門）</label>
            <select id="category1Select" class="form-select">
                <option value="">全部門</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">期間指定</label>
            <input type="date" id="startDate" class="form-control mb-2">
            <div class="text-center text-muted"><i class="bi bi-arrow-down"></i></div>
            <input type="date" id="endDate" class="form-control mt-2">
        </div>

        <div class="d-flex flex-wrap gap-2 mb-3">
            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDateRange('thisMonth')">今月</button>
            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDateRange('lastMonth')">先月</button>
            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDateRange('last7Days')">直近7日</button>
            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDateRange('all')">全期間</button>
        </div>

        <div class="alert alert-info small">
            <i class="bi bi-info-circle me-1"></i>
            効率スコアは「コア業務率」から「削減対象率x0.5」を引いた値です。高いほど効率的です。
        </div>

        <div class="mt-4 d-flex flex-column gap-2">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-primary btn-sm w-100">
                <i class="bi bi-speedometer2 me-1"></i>ダッシュボードへ戻る
            </a>
            <a href="{{ url_for('admin.index') }}" class="btn btn-outline-secondary btn-sm w-100">
                <i class="bi bi-gear me-1"></i>管理設定
            </a>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div class="main-content flex-grow-1 bg-light p-4" style="min-height: 100vh;">
        <!-- ヘッダー -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0"><i class="bi bi-people me-2"></i>スタッフ別比較分析</h4>
            <button class="btn btn-outline-secondary no-print" onclick="window.print()">
                <i class="bi bi-printer me-1"></i>印刷 / PDF
            </button>
        </div>

        <!-- サマリーカード -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">スタッフ数</div>
                            <div class="h3 mb-0"><span id="staffCount">-</span><small class="text-muted">人</small></div>
                        </div>
                        <div class="rounded-circle bg-info bg-opacity-10 p-2">
                            <i class="bi bi-person text-info fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">平均コア業務率</div>
                            <div class="h3 mb-0"><span id="avgCoreRatio">-</span><small class="text-muted">%</small></div>
                        </div>
                        <div class="rounded-circle bg-primary bg-opacity-10 p-2">
                            <i class="bi bi-briefcase text-primary fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">平均削減対象率</div>
                            <div class="h3 mb-0 text-danger"><span id="avgReductionRatio">-</span><small class="text-muted">%</small></div>
                        </div>
                        <div class="rounded-circle bg-danger bg-opacity-10 p-2">
                            <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">総稼働時間</div>
                            <div class="h3 mb-0"><span id="totalHours">-</span><small class="text-muted">h</small></div>
                        </div>
                        <div class="rounded-circle bg-success bg-opacity-10 p-2">
                            <i class="bi bi-clock text-success fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- スタッフ比較テーブル -->
        <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-table me-2"></i>スタッフ別パフォーマンス比較</h6>
                <span class="badge bg-secondary" id="staffBadge">-人</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>スタッフ名</th>
                                <th class="text-end">総時間</th>
                                <th class="text-end">コア業務</th>
                                <th>コア業務率</th>
                                <th class="text-end">削減対象</th>
                                <th>削減対象率</th>
                                <th class="text-center">効率</th>
                            </tr>
                        </thead>
                        <tbody id="staffTable">
                            <tr><td colspan="7" class="text-center py-4 text-muted">データを読み込み中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- カテゴリ別比較グラフ -->
        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-bar-chart-fill me-2"></i>スタッフ別カテゴリ構成比</h6>
            </div>
            <div class="card-body">
                <canvas id="comparisonChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
let comparisonChart = null;
let dateRange = { min: null, max: null };
let categoryColors = {};

document.addEventListener('DOMContentLoaded', async function() {
    await loadCategoryColors();
    loadCategories1();
    loadDateRange();

    document.getElementById('category1Select').addEventListener('change', refreshData);
    document.getElementById('startDate').addEventListener('change', refreshData);
    document.getElementById('endDate').addEventListener('change', refreshData);
});

async function loadCategoryColors() {
    try {
        const response = await fetch('/api/categories/colors');
        const data = await response.json();
        categoryColors = data.colors || {};
    } catch (e) {
        console.error('Failed to load category colors:', e);
    }
}

async function loadCategories1() {
    const response = await fetch('/api/categories1');
    const categories = await response.json();

    const select = document.getElementById('category1Select');
    select.innerHTML = '<option value="">全部門</option>';

    categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
    });
}

async function loadDateRange() {
    const response = await fetch('/api/date-range');
    dateRange = await response.json();

    if (dateRange.min_date && dateRange.max_date) {
        document.getElementById('startDate').value = dateRange.min_date;
        document.getElementById('endDate').value = dateRange.max_date;
    }

    refreshData();
}

function setDateRange(type) {
    const today = new Date();
    let start, end;

    switch(type) {
        case 'thisMonth':
            start = new Date(today.getFullYear(), today.getMonth(), 1);
            end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            break;
        case 'lastMonth':
            start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            end = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
        case 'last7Days':
            start = new Date(today);
            start.setDate(start.getDate() - 7);
            end = today;
            break;
        case 'all':
            document.getElementById('startDate').value = dateRange.min_date || '';
            document.getElementById('endDate').value = dateRange.max_date || '';
            refreshData();
            return;
    }

    document.getElementById('startDate').value = formatDate(start);
    document.getElementById('endDate').value = formatDate(end);
    refreshData();
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function getParams() {
    return {
        category1: document.getElementById('category1Select').value,
        start: document.getElementById('startDate').value,
        end: document.getElementById('endDate').value
    };
}

function buildQueryString(params) {
    return Object.entries(params)
        .filter(([_, v]) => v)
        .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)
        .join('&');
}

async function refreshData() {
    const params = getParams();
    const qs = buildQueryString(params);
    await loadStaffComparison(qs);
}

async function loadStaffComparison(qs) {
    try {
        const response = await fetch(`/api/analytics/staff-comparison?${qs}`);
        const data = await response.json();

        // サマリー更新
        const staffList = data.staff || [];
        document.getElementById('staffCount').textContent = staffList.length;
        document.getElementById('staffBadge').textContent = `${staffList.length}人`;

        if (staffList.length > 0) {
            const avgCore = staffList.reduce((sum, s) => sum + s.core_ratio, 0) / staffList.length;
            const avgReduction = staffList.reduce((sum, s) => sum + s.reduction_ratio, 0) / staffList.length;
            const totalHours = staffList.reduce((sum, s) => sum + s.total_hours, 0);

            document.getElementById('avgCoreRatio').textContent = avgCore.toFixed(1);
            document.getElementById('avgReductionRatio').textContent = avgReduction.toFixed(1);
            document.getElementById('totalHours').textContent = totalHours.toLocaleString();
        } else {
            document.getElementById('avgCoreRatio').textContent = '-';
            document.getElementById('avgReductionRatio').textContent = '-';
            document.getElementById('totalHours').textContent = '-';
        }

        // テーブル更新
        updateStaffTable(staffList);

        // グラフ更新
        updateComparisonChart(staffList, data.category_colors || categoryColors);

    } catch (e) {
        console.error('Failed to load staff comparison:', e);
    }
}

function updateStaffTable(staffList) {
    const tbody = document.getElementById('staffTable');

    if (staffList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">データがありません</td></tr>';
        return;
    }

    tbody.innerHTML = staffList.map(staff => {
        const stars = '&#9733;'.repeat(staff.stars) + '&#9734;'.repeat(3 - staff.stars);

        return `
        <tr class="staff-card">
            <td><strong>${escapeHtml(staff.staff_name)}</strong></td>
            <td class="text-end">${staff.total_hours}h</td>
            <td class="text-end text-primary">${staff.core_hours}h</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress progress-thin flex-grow-1 me-2" style="width: 60px;">
                        <div class="progress-bar bg-primary" style="width: ${staff.core_ratio}%"></div>
                    </div>
                    <span>${staff.core_ratio}%</span>
                </div>
            </td>
            <td class="text-end text-danger">${staff.reduction_hours}h</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress progress-thin flex-grow-1 me-2" style="width: 60px;">
                        <div class="progress-bar bg-danger" style="width: ${staff.reduction_ratio}%"></div>
                    </div>
                    <span>${staff.reduction_ratio}%</span>
                </div>
            </td>
            <td class="text-center">
                <span class="star-rating">${stars}</span>
            </td>
        </tr>
    `}).join('');
}

function updateComparisonChart(staffList, colors) {
    const ctx = document.getElementById('comparisonChart').getContext('2d');

    if (comparisonChart) {
        comparisonChart.destroy();
    }

    if (staffList.length === 0) {
        return;
    }

    // スタッフ名をラベルに
    const labels = staffList.map(s => s.staff_name);

    // カテゴリを収集
    const allCategories = new Set();
    staffList.forEach(s => {
        Object.keys(s.categories).forEach(cat => allCategories.add(cat));
    });

    // データセットを構築
    const datasets = [];
    allCategories.forEach(cat => {
        datasets.push({
            label: cat,
            data: staffList.map(s => s.categories[cat] || 0),
            backgroundColor: colors[cat] || '#999'
        });
    });

    comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: '時間(h)'
                    }
                },
                y: {
                    stacked: true
                }
            }
        }
    });
}

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
</script>
{% endblock %}
