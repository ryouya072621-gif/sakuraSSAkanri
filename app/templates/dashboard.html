{% extends "base.html" %}

{% block title %}個人業務分析レポート{% endblock %}

{% block extra_css %}
<style>
@media print {
    .sidebar { display: none !important; }
    .main-content { margin-left: 0 !important; }
    .no-print { display: none !important; }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex">
    <!-- サイドバー -->
    <div class="sidebar bg-white border-end p-3 no-print" style="width: 280px; min-height: 100vh;">
        <div class="d-flex align-items-center mb-4">
            <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                <i class="bi bi-bar-chart text-white"></i>
            </div>
            <div>
                <h5 class="mb-0">個人業務分析レポート</h5>
                <small class="text-muted">期間別 業務構成比・生産性分析</small>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">分析条件設定</label>
        </div>

        <div class="mb-3">
            <label class="form-label">大分類（部門）</label>
            <select id="category1Select" class="form-select">
                <option value="">全部門</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">対象スタッフ</label>
            <select id="staffSelect" class="form-select">
                <option value="">読み込み中...</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">期間指定</label>
            <input type="date" id="startDate" class="form-control mb-2">
            <div class="text-center text-muted"><i class="bi bi-arrow-down"></i></div>
            <input type="date" id="endDate" class="form-control mt-2">
        </div>

        <div class="d-flex flex-wrap gap-2 mb-3">
            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDateRange('thisMonth')">今月</button>
            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDateRange('lastMonth')">先月</button>
            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDateRange('last7Days')">直近7日</button>
            <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="setDateRange('all')">全期間</button>
        </div>

        <div class="mb-4">
            <label class="form-label">想定時給 (コスト試算用) <span class="text-muted">※任意</span></label>
            <div class="input-group">
                <span class="input-group-text">¥</span>
                <input type="number" id="hourlyRate" class="form-control" value="2000">
            </div>
        </div>

        <div class="alert alert-info small">
            <i class="bi bi-info-circle me-1"></i>
            8%削減のターゲットを見つけるには、赤色で表示される「その他・不明・移動」の割合に注目してください。
        </div>

        <div class="mt-4 d-flex flex-column gap-2">
            <a href="{{ url_for('main.department_overview') }}" class="btn btn-outline-warning btn-sm w-100">
                <i class="bi bi-building me-1"></i>部門比較ダッシュボード
            </a>
            <a href="{{ url_for('main.project_analysis') }}" class="btn btn-outline-success btn-sm w-100">
                <i class="bi bi-diagram-3 me-1"></i>プロジェクト別分析
            </a>
            <a href="{{ url_for('main.staff_comparison') }}" class="btn btn-outline-info btn-sm w-100">
                <i class="bi bi-people me-1"></i>スタッフ別比較
            </a>
            <a href="{{ url_for('upload.index') }}" class="btn btn-outline-secondary btn-sm w-100">
                <i class="bi bi-cloud-upload me-1"></i>データを再アップロード
            </a>
            <a href="{{ url_for('admin.index') }}" class="btn btn-outline-primary btn-sm w-100">
                <i class="bi bi-gear me-1"></i>管理設定
            </a>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div class="main-content flex-grow-1 bg-light p-4" style="min-height: 100vh;">
        <!-- ヘッダー -->
        <div class="d-flex justify-content-end mb-4 no-print">
            <button class="btn btn-outline-secondary" onclick="window.print()">
                <i class="bi bi-printer me-1"></i>印刷 / PDF
            </button>
        </div>

        <!-- KPIカード -->
        <div class="row g-3 mb-4">
            <div class="col">
                <div class="card h-100">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">総稼働時間</div>
                            <div class="h3 mb-0"><span id="totalHours">-</span><small class="text-muted">h</small></div>
                        </div>
                        <div class="rounded-circle bg-primary bg-opacity-10 p-2">
                            <i class="bi bi-clock text-primary fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">総処理件数</div>
                            <div class="h3 mb-0"><span id="totalCount">-</span><small class="text-muted">件</small></div>
                        </div>
                        <div class="rounded-circle bg-purple bg-opacity-10 p-2" style="background-color: rgba(139,92,246,0.1);">
                            <i class="bi bi-hash text-purple fs-4" style="color: #8B5CF6;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">推定コスト</div>
                            <div class="h3 mb-0">¥<span id="totalCost">-</span></div>
                        </div>
                        <div class="rounded-circle bg-success bg-opacity-10 p-2">
                            <i class="bi bi-currency-yen text-success fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small">タスク種類数</div>
                            <div class="h3 mb-0"><span id="taskTypes">-</span></div>
                        </div>
                        <div class="rounded-circle bg-info bg-opacity-10 p-2">
                            <i class="bi bi-list-task text-info fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card h-100 border-danger">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-danger small">削減対象(その他等)</div>
                            <div class="h3 mb-0 text-danger"><span id="reductionRatio">-</span>%</div>
                        </div>
                        <div class="rounded-circle bg-danger bg-opacity-10 p-2">
                            <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 異常値アラートセクション -->
        <div id="alertsSection" class="mb-4" style="display: none;">
            <!-- JSで動的に生成 -->
        </div>

        <!-- AIインサイトパネル -->
        <div class="row g-3 mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-robot me-2 text-warning"></i>AI分析インサイト</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="generateAIReport('weekly')" title="週次レポート生成">
                                <i class="bi bi-file-text me-1"></i>レポート
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="refreshAIInsights()" title="更新">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="aiInsightsContent">
                        <div class="text-center py-3 text-muted">
                            <div class="spinner-border spinner-border-sm me-2"></div>
                            AIが分析中...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- グラフエリア -->
        <div class="row g-3 mb-4">
            <div class="col-md-5">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>業務カテゴリ構成比</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>日次業務内訳の推移</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 削減対象業務の推移グラフ -->
        <div class="row g-3 mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>削減対象業務の推移</h6>
                        <div class="d-flex align-items-center gap-3">
                            <div id="goalIndicator" class="small text-muted" style="display: none;">
                                <span class="badge bg-danger">目標: <span id="goalPercent">-</span>%削減</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="trendChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- ランキングテーブル -->
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-list-ol me-2"></i>業務別 時間消費ランキング</h6>
                <div class="d-flex align-items-center gap-2">
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="rankingMode" id="rankingModeNormal" checked onchange="toggleRankingMode(false)">
                        <label class="btn btn-outline-secondary" for="rankingModeNormal" title="通常表示">
                            <i class="bi bi-list"></i>
                        </label>
                        <input type="radio" class="btn-check" name="rankingMode" id="rankingModeGroup" onchange="toggleRankingMode(true)">
                        <label class="btn btn-outline-secondary" for="rankingModeGroup" title="グループ表示（類似業務をまとめる）">
                            <i class="bi bi-collection"></i>
                        </label>
                    </div>
                    <span id="rankingBadge" class="badge bg-secondary">上位10項目</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light" id="rankingTableHead">
                            <tr>
                                <th>業務名</th>
                                <th>カテゴリ</th>
                                <th class="text-end">合計時間</th>
                                <th>割合</th>
                                <th class="text-end">推定コスト</th>
                                <th>判定</th>
                                <th class="text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="rankingTable">
                            <tr><td colspan="7" class="text-center py-4 text-muted">データを読み込み中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AIチャットウィジェット -->
<div class="position-fixed bottom-0 end-0 m-4 no-print" style="z-index: 1050;">
    <!-- チャットウィンドウ -->
    <div id="chatWidget" class="card shadow-lg mb-2" style="width: 350px; display: none; flex-direction: column;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-2">
            <span><i class="bi bi-robot me-2"></i>AI アシスタント</span>
            <button class="btn btn-sm btn-link text-white p-0" onclick="toggleChat()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="card-body p-2" id="chatMessages" style="height: 300px; overflow-y: auto;">
            <!-- メッセージはJSで動的に追加 -->
        </div>
        <div class="card-footer p-2">
            <div class="input-group input-group-sm">
                <input type="text" class="form-control" id="chatInput" placeholder="質問を入力...">
                <button class="btn btn-primary" onclick="sendChatMessage()">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
    <!-- チャットトグルボタン -->
    <button class="btn btn-primary btn-lg rounded-circle shadow" onclick="toggleChat()" title="AIアシスタント">
        <i class="bi bi-chat-dots"></i>
    </button>
</div>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/ai-features.js') }}"></script>
{% endblock %}
